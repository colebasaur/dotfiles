# Set NVIM as the default editor
export EDITOR='nvim'

# Homebrew setup (macOS only)
if [[ "$OSTYPE" == "darwin"* ]]; then
  if [[ -f "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -f "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
fi

# Golang environment
export PATH="$(go env GOPATH)/bin:$PATH"

fpath=(~/.zsh/completions $fpath)
autoload -Uz compinit && compinit

# Zinit Plugin Manager initialization
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
[[ ! -d "$ZINIT_HOME" ]] && mkdir -p "$(dirname $ZINIT_HOME)" && git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
source "$ZINIT_HOME/zinit.zsh"
# ZSH plugins setup with Zinit
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-completions
zinit light zsh-users/zsh-autosuggestions

# Load platform-specific configuration
if [[ "$OSTYPE" == "darwin"* ]]; then
  [[ -f "$HOME/.zshrc.macos" ]] && source "$HOME/.zshrc.macos"
else
  [[ -f "$HOME/.zshrc.linux" ]] && source "$HOME/.zshrc.linux"
fi

# Environment configuration for Python, Direnv, Gcloud, and other tools
export PYENV_ROOT="$HOME/.pyenv"

# Core PATH elements
export PATH="$PYENV_ROOT/bin:$PATH"
export PATH="$HOME/.jenv/bin:$PATH"
export PATH="$HOME/.bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# Platform-specific PATH additions
if [[ "$OSTYPE" == "darwin"* ]]; then
  [[ -n "$HOMEBREW_PREFIX" ]] && export PATH="$HOMEBREW_PREFIX/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/bin:$PATH"
  [[ -d "$HOME/.rd/bin" ]] && export PATH="$HOME/.rd/bin:$PATH"
else
  [[ -d "/opt/google-cloud-sdk/bin" ]] && export PATH="/opt/google-cloud-sdk/bin:$PATH"
fi
eval "$(pyenv init --path)"
eval "$(pyenv init -)"
export VIRTUAL_ENV_DISABLE_PROMPT=1
eval "$(pyenv virtualenv-init -)"
eval "$(direnv hook zsh)"
eval "$(jenv init -)"
export USE_GKE_GCLOUD_AUTH_PLUGIN=True

# Custom scripts and secrets
export CODE_BASE_REPO="$HOME/code"

# autojump - only on macOS (Omarchy uses enhanced cd by default)
if [[ "$OSTYPE" == "darwin"* ]]; then
  [[ -f "$HOMEBREW_PREFIX/etc/profile.d/autojump.sh" ]] && . "$HOMEBREW_PREFIX/etc/profile.d/autojump.sh"
fi

# Load organization-specific settings (if file exists)
[[ -f "$HOME/.zshrc.work" ]] && source "$HOME/.zshrc.work"

source ~/.aliases
source ~/.functions

. "$HOME/.atuin/bin/env"

eval "$(atuin init zsh)"
bindkey '^p' atuin-up-search
bindkey '^n' atuin-down-search

# Uncomment to measure starship init time
# if [[ "$OSTYPE" == "darwin"* ]]; then
#   local start_time=$(gdate +%s%N)
# else
#   local start_time=$(date +%s%N)
# fi
eval "$(starship init zsh)"
# if [[ "$OSTYPE" == "darwin"* ]]; then
#   local end_time=$(gdate +%s%N)
# else
#   local end_time=$(date +%s%N)
# fi
# echo "Starship init took: $(((end_time - start_time) / 1000000))ms"

. "$HOME/.local/share/../bin/env"
