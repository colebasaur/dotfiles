#!/bin/bash

version="${1:-}"
if [[ -z $version ]]; then
  python_version=$(python --version)
  version="${python_version#* }"
  version="${version%.*}"
fi
echo "$version"

if [[ -z $2 ]]; then
  echo "Must provide venv name"
  exit 1
fi

if [[ ! -f "pyrightconfig.json" ]]; then
  cat >pyrightconfig.json <<EOF
{
  "pythonVersion": "${version}",
  "venvPath": "$HOME/.pyenv/versions",
  "venv": "$2"
}
EOF
fi

if [[ -z $PYTHONPATH ]]; then
  echo 'export PYTHONPATH=$(pwd)' >>.envrc
fi

if [[ -z $PYENV_VERSION ]]; then
  echo "export PYENV_VERSION=\"$2\"" >>.envrc
fi

if [[ ! -f Makefile ]]; then
  cat <<EOF >Makefile
help:
	@echo "make venv"
	@echo "    Create virtual environment and install requirements"
venv:
	@pyenv install ${version} --skip-existing
	@pyenv virtualenv -f ${version} $2
EOF
fi

direnv allow
